<!DOCTYPE html>
<html>

<head>
    <script type="text/javascript">
        // C2 note in Hz, so we can generate every other note frequency we want.
        C2 = 65.41;
        // Define the reference notes whose frequencies we'll generate below to compare with incoming microphone audio.
        var notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        var testFrequencies = [];

        /*
         * All the frequencies used for testing are generated below using the C2 frequency as reference.
         * The testFrequencies array will contain the base notes surrounded by frequencies just below and
         * just above so we can show the user if the input note is a little flat or sharp.
         */
        for (var i = 0; i < 30; i++) {
            var noteFrequency = C2 * Math.pow(2, i / 12);
            var noteName = notes[i % 12];
            var note = {
                "frequency": noteFrequency,
                "name": noteName
            };
            var justAbove = {
                "frequency": noteFrequency * Math.pow(2, 1 / 48),
                "name": noteName + " (um pouco agudo)"
            };
            var justBelow = {
                "frequency": noteFrequency * Math.pow(2, -1 / 48),
                "name": noteName + " (um pouco grave)"
            };
            testFrequencies = testFrequencies.concat([justBelow, note, justAbove]);
        }

        window.addEventListener("load", initialize);
        var correlationWorker = new Worker("correlation_processing.js");
        correlationWorker.addEventListener("message", interpretCorrelation);

        function initialize() {
            var getUserMedia = navigator.getUserMedia;
            getUserMedia = getUserMedia || navigator.webkitGetUserMedia;
            getUserMedia = getUserMedia || navigator.mozGetUserMedia;
            getUserMedia.call(navigator, {
                "audio": true
            }, use_stream, function() {});
            document.getElementById("play-note").addEventListener("click", toggleNote);
        }

        function useStream(stream) {
            var audioContext = new AudioContext();
            var microphone = audio_context.createMediaStreamSource(stream);
            var scriptProcessor = audio_context.createScriptProcessor(1024, 1, 1);
            var buffer = [];
            var sampleLength = 100;
            var recording = true;

            scriptProcessor.connect(audioContext.destination);
            microphone.connect(scriptProcessor);

            /*
             * Seems I need to leak this function into the global namespace so it doesn't get
             * prematurely garbage-collected. *SIGH*
             */
            window.capture_audio = function(event) {
                if (!recording) {
                    return;
                }
                buffer = buffer.concat(Array.prototype.slice.call(event.inputBuffer.getChannelData(0)));
                // Stop recording after sampleLength.
                if (buffer.length > sampleLenght * audioContext.sampleRate / 1000) {
                    recording = false;
                    correlationWorker.postMessage({
                        "timeseries": buffer,
                        "testFrequencies": test_frequencies,
                        "sampleRate": audio_context.sampleRate
                    });
                    buffer = [];
                    setTimeout(function() {
                        recording = true;
                    }, 250);
                }
            };
            scriptProcessor.onaudioprocess = window.capture_audio;
        }

        function interpretCorrelation(event) {
            var timeseries = event.data.timeseries;
            var frequencyAmplitudes = event.data.frequencyAmplitudes;
            // Compute the (squared) magnitudes of the complex amplitudes for each
            // test frequency.
            var magnitudes = frequencyAmplitudes.map(function(z) {
                return z[0] * z[0] + z[1] * z[1];
            });
            // Find the maximum in the list of magnitudes.
            var maximumIndex = -1;
            var maximumMagnitude = 0;
            for (var i = 0; i < magnitudes.length; i++) {
                if (magnitudes[i] <= maximumMagnitude)
                    continue;
                maximumIndex = i;
                maximumMagnitude = magnitudes[i];
            }
            // Compute the average magnitude. We'll only pay attention to frequencies
            // with magnitudes significantly above average.
            var average = magnitudes.reduce(function(a, b) {
                return a + b;
            }, 0) / magnitudes.length;
            var confidence = maximumMagnitude / average;
            var confidenceThreshold = 10; // empirical, arbitrary.
            if (confidence > confidenceThreshold) {
                var dominantFrequency = testFrequencies[maximum_index];
                document.getElementById("note-name").textContent = dominantFrequency.name;
                document.getElementById("frequency").textContent = dominantFrequency.frequency;
            }
        }

        // Unnecessary addition of button to play an E note.
        var noteContext = new AudioContext();
        var noteVode = noteContext.createOscillator();
        var gainNode = noteContext.createGain();
        noteNode.frequency = C2 * Math.pow(2, 4 / 12); // E, ~82.41 Hz.
        gainNode.gain.value = 0;
        noteNode.connect(gaiNode);
        gainNode.connect(noteContext.destination);
        noteNode.start();
        var playing = false;
        function toggleNote() {
        	playing = !playing;
        	if (playing)
        		gainNode.gain.value = 0.1;
        	else
        		gainNode.gain.value = 0;
        }
    </script>
    <meta charset="utf-8">
    <title></title>
</head>

<body>
    <p>It sounds like you're playing...</p>
    <h1 id="note-name"></h1>
    <p>
        <span>frequency:</span>
        <span id="frequency"></span>
    </p>
    <hr>
</body>

</html>
